# LocalSend è®¾å¤‡å‘ç°ç­–ç•¥æ·±åº¦åˆ†æ

åŸºäº LocalSend æºç åˆ†æï¼ˆDart/Flutterï¼‰

## ğŸ“‹ å‘ç°ç­–ç•¥æ€»è§ˆ

LocalSend ä½¿ç”¨ **ä¸‰ç§å‘ç°æœºåˆ¶**ï¼Œä¼˜å…ˆçº§é€’å‡ï¼š

1. **UDP å¤šæ’­ï¼ˆä¸»è¦ï¼‰** - Multicast Discovery
2. **HTTP å“åº”ï¼ˆè¾…åŠ©ï¼‰** - HTTP Register Response
3. **HTTP æ‰«æï¼ˆå¤‡ç”¨ï¼‰** - HTTP Scan Discovery

## ğŸ¯ è¯¦ç»†ç­–ç•¥åˆ†æ

### 1ï¸âƒ£ UDP å¤šæ’­å‘ç°ï¼ˆä¸»è¦æœºåˆ¶ï¼‰

#### å·¥ä½œæµç¨‹

```
è®¾å¤‡ A å¯åŠ¨
  â†“
å‘é€ UDP å¤šæ’­å…¬å‘Š (announcement=true)
  â†“
è®¾å¤‡ B æ”¶åˆ°å…¬å‘Š
  â†“
è®¾å¤‡ B å°è¯•é€šè¿‡ HTTP å“åº”
  â†“ (å¦‚æœ HTTP å¤±è´¥)
è®¾å¤‡ B é€šè¿‡ UDP å¤šæ’­å“åº”
```

#### å…³é”®ç‰¹æ€§

**å¯åŠ¨æ—¶å¹¿æ’­**:
```dart
// å¯åŠ¨ç›‘å¬å™¨æ—¶ç«‹å³å‘é€å…¬å‘Š
sendAnnouncement()

// åˆ†ä¸‰æ¬¡å‘é€ï¼Œé—´éš”é€’å¢
for (final wait in [100, 500, 2000]) {
  await sleepAsync(wait);
  socket.send(dto, multicastGroup, port);
}
```

**ä¸ºä»€ä¹ˆå‘é€ 3 æ¬¡ï¼Ÿ**
- 100ms: å¿«é€Ÿå“åº”ï¼ˆå¯èƒ½ä¸¢åŒ…ï¼‰
- 500ms: ç¬¬äºŒæ¬¡å°è¯•
- 2000ms: æœ€åç¡®è®¤
- **ç›®çš„**: æé«˜å¯é æ€§ï¼Œé˜²æ­¢ UDP ä¸¢åŒ…

**æ¶ˆæ¯æ ¼å¼**:
```json
{
  "alias": "è®¾å¤‡åç§°",
  "version": "2.0",
  "deviceModel": "è®¾å¤‡å‹å·",
  "deviceType": "desktop|mobile|web",
  "fingerprint": "è®¾å¤‡å”¯ä¸€æŒ‡çº¹",
  "port": 53317,
  "protocol": "https",
  "download": false,
  "announcement": true,  // æ˜¯å…¬å‘Šè¿˜æ˜¯å“åº”
  "announce": true       // å…¼å®¹å­—æ®µ
}
```

#### æ¥æ”¶é€»è¾‘

```dart
socket.listen((_) {
  final datagram = socket.receive();
  final dto = MulticastDto.fromJson(jsonDecode(utf8.decode(datagram.data)));

  // 1. è¿‡æ»¤è‡ªå·±
  if (dto.fingerprint == myFingerprint) {
    return;
  }

  // 2. è§£æè®¾å¤‡ä¿¡æ¯
  final ip = datagram.address.address;  // ä» UDP æºåœ°å€è·å–
  final peer = dto.toDevice(ip, ...);

  // 3. å¦‚æœæ˜¯å…¬å‘Šï¼Œä¸”æœåŠ¡å™¨è¿è¡Œä¸­ï¼Œåˆ™å“åº”
  if ((dto.announcement == true || dto.announce == true) && serverRunning) {
    _answerAnnouncement(peer);
  }
});
```

### 2ï¸âƒ£ HTTP å“åº”ï¼ˆåŒå‘ç¡®è®¤ï¼‰

#### å“åº”å…¬å‘Šçš„ç­–ç•¥

å½“æ”¶åˆ° UDP å…¬å‘Šåï¼Œä¼˜å…ˆä½¿ç”¨ HTTP å“åº”ï¼š

```dart
Future<void> _answerAnnouncement(Device peer) async {
  try {
    // ä¼˜å…ˆï¼šé€šè¿‡ HTTP/TCP å“åº”
    await httpClient.post(
      uri: 'http://${peer.ip}:${peer.port}/api/localsend/v2/register',
      json: registerDto.toJson(),
    );
    logger.info('Respond via TCP');

  } catch (e) {
    // Fallbackï¼šHTTP å¤±è´¥ï¼Œæ”¹ç”¨ UDP å“åº”
    final dto = _getMulticastDto(announcement: false);
    socket.send(dto, multicastGroup, port);
    logger.info('Respond with UDP because TCP failed');
  }
}
```

**ä¸ºä»€ä¹ˆä¼˜å…ˆ HTTPï¼Ÿ**
- âœ… æ›´å¯é ï¼ˆTCP æœ‰ç¡®è®¤æœºåˆ¶ï¼‰
- âœ… ä¸å—å¤šæ’­é™åˆ¶ï¼ˆæŸäº›ç½‘ç»œç¦ç”¨å¤šæ’­ï¼‰
- âœ… å¯ä»¥ä¼ é€’æ›´å¤šä¿¡æ¯
- âœ… å»ºç«‹ç›´æ¥è¿æ¥

**HTTP ç«¯ç‚¹**:
```
POST /api/localsend/v2/register
Body: {
  "alias": "...",
  "version": "2.0",
  "deviceModel": "...",
  "deviceType": "...",
  "fingerprint": "...",
  "port": 53317,
  "protocol": "https",
  "download": false
}
```

### 3ï¸âƒ£ HTTP æ‰«æå‘ç°ï¼ˆå¤‡ç”¨æœºåˆ¶ï¼‰

å½“ UDP å¤šæ’­ä¸å¯ç”¨æ—¶ï¼ˆå¦‚ AP éš”ç¦»ï¼‰ï¼Œä½¿ç”¨ HTTP æ‰«æï¼š

#### æ‰«æç­–ç•¥

```dart
// ç”Ÿæˆæ•´ä¸ªå­ç½‘çš„ IP åˆ—è¡¨
final ipList = List.generate(256, (i) =>
  '${networkInterface.split('.').take(3).join('.')}.$i'
).where((ip) => ip != myIp).toList();

// å¹¶å‘æ‰«æï¼ˆå¹¶å‘æ•°ï¼š50ï¼‰
TaskRunner<Device?>(
  initialTasks: ipList.map((ip) =>
    () async => _doRequest(ip, port, https)
  ).toList(),
  concurrency: 50,
);
```

#### å‘ç°è¯·æ±‚

```dart
Future<Device?> _doRequest(String ip, int port, bool https) async {
  final url = 'http://$ip:$port/api/localsend/v2/info?fingerprint=$myFingerprint';
  try {
    final response = await httpClient.get(uri: url);
    final dto = InfoDto.fromJson(response);
    return dto.toDevice(ip, port, https);
  } catch (e) {
    return null;
  }
}
```

**æ‰«æç‰¹ç‚¹**:
- æ‰«ææ•´ä¸ªå­ç½‘ï¼ˆ255 ä¸ª IPï¼‰
- å¹¶å‘ 50 ä¸ªè¯·æ±‚ï¼ˆå¹³è¡¡é€Ÿåº¦å’Œèµ„æºï¼‰
- è¶…æ—¶å¿«é€Ÿå¤±è´¥
- åªè¯·æ±‚ `/info` ç«¯ç‚¹ï¼ˆè½»é‡çº§ï¼‰

## ğŸ”„ å®Œæ•´å‘ç°æµç¨‹

### åœºæ™¯ 1: æ­£å¸¸æƒ…å†µï¼ˆUDP å¤šæ’­å¯ç”¨ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¾å¤‡ A  â”‚                           â”‚ è®¾å¤‡ B  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                                     â”‚
     â”‚ 1. å¯åŠ¨ï¼ŒåŠ å…¥å¤šæ’­ç»„                 â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                     â”‚
     â”‚ 2. å‘é€ UDP å…¬å‘Š (3æ¬¡)              â”‚
     â”‚ announcement=true                   â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                                     â”‚
     â”‚                          3. æ”¶åˆ°å…¬å‘Šï¼Œè§£æ IP
     â”‚                                     â”‚
     â”‚                       4. å°è¯• HTTP å“åº”
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚ POST /api/localsend/v2/register     â”‚
     â”‚                                     â”‚
     â”‚ 5. æ”¶åˆ° HTTP æ³¨å†Œ                   â”‚
     â”‚    åŒå‘å‘ç°å®Œæˆ âœ“                   â”‚
```

### åœºæ™¯ 2: HTTP å¤±è´¥ï¼ˆTCP ç«¯å£ä¸é€šï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¾å¤‡ A  â”‚                           â”‚ è®¾å¤‡ B  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                                     â”‚
     â”‚ 1. UDP å…¬å‘Š                         â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                                     â”‚
     â”‚                          2. æ”¶åˆ°å…¬å‘Š
     â”‚                                     â”‚
     â”‚                       3. å°è¯• HTTP å“åº”
     â”‚<â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€â”‚
     â”‚           (HTTP å¤±è´¥)                â”‚
     â”‚                                     â”‚
     â”‚                       4. Fallback UDP å“åº”
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚ announcement=false                  â”‚
     â”‚                                     â”‚
     â”‚ 5. æ”¶åˆ° UDP å“åº”                    â”‚
     â”‚    å‘ç°å®Œæˆ âœ“                       â”‚
```

### åœºæ™¯ 3: UDP å¤šæ’­è¢«ç¦ç”¨ï¼ˆAP éš”ç¦»ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¾å¤‡ A  â”‚                           â”‚ è®¾å¤‡ B  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                                     â”‚
     â”‚ 1. UDP å…¬å‘Šå‘é€å¤±è´¥                 â”‚
     â”‚    æˆ–è¢«è·¯ç”±å™¨ä¸¢å¼ƒ                   â”‚
     â”‚                                     â”‚
     â”‚ 2. å¯åŠ¨ HTTP æ‰«æ                   â”‚
     â”‚    192.168.1.1 - 192.168.1.254      â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚ GET /api/localsend/v2/info          â”‚
     â”‚                                     â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚ è¿”å›è®¾å¤‡ä¿¡æ¯                         â”‚
     â”‚                                     â”‚
     â”‚ 3. æ‰«æå®Œæˆï¼Œå‘ç°è®¾å¤‡ âœ“              â”‚
```

## ğŸ“Š å¯¹æ¯”ï¼šå½“å‰å®ç° vs LocalSend

| ç‰¹æ€§ | å½“å‰å®ç° | LocalSend |
|------|---------|-----------|
| **UDP å¤šæ’­** | âœ… å®ç° | âœ… å®ç° |
| å¯åŠ¨å¹¿æ’­ | âœ… 1æ¬¡ | âœ… 3æ¬¡ï¼ˆ100ms, 500ms, 2000msï¼‰|
| å®šæœŸå¹¿æ’­ | âœ… æ¯3ç§’ | âŒ ä»…å¯åŠ¨æ—¶ |
| **HTTP å“åº”** | âŒ æœªå®ç° | âœ… ä¼˜å…ˆä½¿ç”¨ |
| UDP Fallback | âŒ æœªå®ç° | âœ… HTTPå¤±è´¥æ—¶ |
| **HTTP æ‰«æ** | âŒ æœªå®ç° | âœ… å¤‡ç”¨æ–¹æ¡ˆ |
| å­ç½‘æ‰«æ | âŒ æœªå®ç° | âœ… 255ä¸ªIPå¹¶å‘50 |
| **å…¶ä»–** | | |
| è¿‡æ»¤è‡ªå·± | âœ… fingerprint | âœ… fingerprint |
| è®¾å¤‡ç±»å‹ | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| åŒå‘ç¡®è®¤ | âš ï¸ å•å‘ | âœ… åŒå‘ |

## ğŸ“ å…³é”®è®¾è®¡æ€æƒ³

### 1. ä¸‰å±‚å‘ç°ç­–ç•¥

```
ç¬¬ä¸€å±‚: UDP å¤šæ’­ï¼ˆå¿«é€Ÿã€è½»é‡ï¼‰
   â†“ å¤±è´¥
ç¬¬äºŒå±‚: HTTP ç›´æ¥å“åº”ï¼ˆå¯é ï¼‰
   â†“ å¤±è´¥
ç¬¬ä¸‰å±‚: HTTP å­ç½‘æ‰«æï¼ˆå…œåº•ï¼‰
```

### 2. åŒå‘ç¡®è®¤æœºåˆ¶

```
A å‘é€å…¬å‘Š â†’ B æ”¶åˆ°
            â†“
B å“åº”æ³¨å†Œ â† A æ”¶åˆ°
            â†“
    åŒå‘å‘ç°å®Œæˆ
```

### 3. å®¹é”™è®¾è®¡

- UDP å‘é€ 3 æ¬¡ï¼ˆé˜²ä¸¢åŒ…ï¼‰
- HTTP å¤±è´¥è‡ªåŠ¨é™çº§åˆ° UDP
- UDP ä¸å¯ç”¨æ—¶å¯ç”¨ HTTP æ‰«æ

### 4. æ€§èƒ½ä¼˜åŒ–

- HTTP æ‰«æå¹¶å‘æ§åˆ¶ï¼ˆ50ä¸ªï¼‰
- è¶…æ—¶å¿«é€Ÿå¤±è´¥
- åªåœ¨éœ€è¦æ—¶å¯åŠ¨æ‰«æ

## ğŸ’¡ æ”¹è¿›å»ºè®®

### å½“å‰å®ç°ç¼ºå°‘çš„å…³é”®åŠŸèƒ½

1. **HTTP åŒå‘ç¡®è®¤**
   ```javascript
   // æ”¶åˆ° UDP å…¬å‘Šå
   async handleUDPMessage(msg, rinfo) {
     const device = parseDevice(msg);

     // å°è¯• HTTP æ³¨å†Œ
     try {
       await axios.post(`http://${device.ip}:${device.port}/api/localsend/v2/register`,
         this.getDeviceInfo()
       );
     } catch (e) {
       // Fallback: UDP å“åº”
       this.sendUDPResponse(device);
     }
   }
   ```

2. **HTTP æ‰«æå¤‡ç”¨**
   ```javascript
   // å½“ UDP å¤šæ’­ä¸å¯ç”¨æ—¶
   async scanSubnet() {
     const myIP = this.getLocalIP();
     const subnet = myIP.split('.').slice(0, 3).join('.');

     const promises = [];
     for (let i = 1; i < 255; i++) {
       promises.push(this.tryDiscoverDevice(`${subnet}.${i}`));
     }

     // å¹¶å‘æ§åˆ¶
     const results = await pLimit(50)(promises);
     return results.filter(d => d !== null);
   }
   ```

3. **å¯åŠ¨æ—¶å¤šæ¬¡å¹¿æ’­**
   ```javascript
   async sendAnnouncementSequence() {
     for (const delay of [100, 500, 2000]) {
       await sleep(delay);
       this.announceViaUDP();
     }
   }
   ```

## ğŸ“ æ€»ç»“

LocalSend çš„å‘ç°ç­–ç•¥æ˜¯ä¸€ä¸ª **åˆ†å±‚ã€å®¹é”™ã€ä¼˜åŒ–** çš„è®¾è®¡ï¼š

- **åˆ†å±‚**: UDP â†’ HTTP Response â†’ HTTP Scan
- **å®¹é”™**: æ¯å±‚å¤±è´¥è‡ªåŠ¨é™çº§
- **ä¼˜åŒ–**: å¹¶å‘æ§åˆ¶ã€å¿«é€Ÿå¤±è´¥ã€èµ„æºç®¡ç†

è¿™ç§è®¾è®¡ç¡®ä¿åœ¨å„ç§ç½‘ç»œç¯å¢ƒä¸‹éƒ½èƒ½å¯é åœ°å‘ç°è®¾å¤‡ã€‚
