# LAN Discovery - 局域网设备自动发现

基于 LocalSend 协议的局域网设备自动发现工具，支持 UDP 多播 + HTTP 扫描双重发现机制。

## 特性

- ✅ **智能发现** - 自动适应各种网络环境（正常网络/AP隔离/企业网络）
- ✅ **三层策略** - UDP 多播 → HTTP 响应 → HTTP 扫描
- ✅ **智能过滤** - 自动识别并优先扫描真实网络（WiFi/以太网），过滤虚拟网卡/VPN/APIPA
- ✅ **跨子网发现** - 支持配置额外子网，解决企业网络跨网段问题
- ✅ **零配置** - 开箱即用，无需手动设置
- ✅ **实时显示** - 自动刷新设备列表，显示发现方式
- ✅ **双向确认** - TCP/UDP 混合，确保可靠发现

## 配置跨子网发现

### 问题场景

**企业网络跨网段场景**：
```
A 设备: 192.168.11.196  (你的电脑)
B 设备: 192.168.1.24    (同事的电脑)

虽然不同子网，但有路由器连接：
- A 能 telnet 到 B ✓
- B 不能 telnet 到 A ✗
- UDP 多播不跨子网 ✗
- HTTP 扫描只扫本地子网 ✗
```

### 解决方案：配置额外子网

**自动创建配置文件**：
- 首次运行时，如果 `config.json` 不存在，程序会自动创建默认配置
- 默认包含 `192.168.1` 和 `192.168.11` 两个常用网段
- 如果你已经手动创建了 `config.json`，程序会优先使用你的配置

**手动编辑** `config.json` 添加要扫描的子网：

```json
{
  "additionalSubnets": [
    "192.168.1",    // 扫描 192.168.1.1-254
    "192.168.11",   // 扫描 192.168.11.1-254
    "10.0.0"        // 扫描 10.0.0.1-254
  ]
}
```

**效果**：
- A 设备会扫描 `192.168.11.x` (本地) + `192.168.1.x` (配置)
- 即使 UDP 多播失败，也能通过 HTTP 扫描发现 B
- 单向连接也能工作（A 能访问 B 就够了）

### 优先级规则

```
WiFi 本地网卡             → 100  (最高)
配置文件子网              → 30   (中高)
以太网本地网卡            → 50   (高)
普通本地网卡              → 10   (中)
虚拟网卡/VPN/APIPA        → <0   (过滤)

取前 3 个子网扫描
```

**示例**（你的网络）：
```
1. WLAN (192.168.11.x)            - Priority: 100  [本地网卡] ✓ 扫描
2. Configured (192.168.1.x)       - Priority: 30   [配置文件] ✓ 扫描
3. 本地连接 (192.168.137.x)       - Priority: 1    [本地网卡] ✓ 扫描

结果: 扫描 3 个子网，包括 B 所在的 192.168.1.x ✓
```

## 快速开始

### 安装运行

```bash
# 安装依赖
npm install

# 启动
node index.js

# 或双击
start.bat    # Windows
./start.sh   # Linux/Mac
```

### 基本使用

```bash
# 启动后，输入命令：
> list     # 自动刷新 + 智能扫描（推荐）
> info     # 查看本机信息
> quit     # 退出

# 也可以用简写
> l
> i
> q
```

### 测试发现

**单机测试**（开两个终端）:
```bash
# 终端 1
node index.js
> list

# 终端 2
node index.js
> list

# 2秒内互相发现
```

**多机测试**:
- 同一局域网内的多台设备
- 每台运行 `node index.js`
- 自动互相发现

## 工作原理

### 三层发现策略

```
第一层: UDP 多播（快速）
  ├─ 0-2秒发现
  ├─ 适用: 正常网络
  └─ 标记: [多播发现]

第二层: HTTP 双向响应（可靠）
  ├─ 收到公告立即 HTTP 响应
  ├─ TCP 确认，防止丢包
  └─ 适用: UDP 单向成功

第三层: HTTP 子网扫描（兜底）
  ├─ 10秒后自动触发
  ├─ 适用: AP 隔离/企业网络
  └─ 标记: [HTTP扫描]
```

### 自动适应网络

| 网络环境 | 发现方式 | 延迟 | 自动处理 |
|----------|----------|------|----------|
| 正常网络 | UDP 多播 | 0-2秒 | ✅ |
| AP 隔离 | HTTP 扫描 | 10-30秒 | ✅ 自动触发 |
| 企业网络 | HTTP 响应/扫描 | 2-30秒 | ✅ 智能降级 |

### 设备列表示例

```
--- Discovered Devices (14:30:25) ---
1. LAPTOP-001 (desktop) [多播发现]
   IP: 192.168.1.100 | URL: http://192.168.1.100:53317
2. PC-002 (desktop) [HTTP扫描]
   IP: 192.168.1.150 | URL: http://192.168.1.150:53317
--------------------------
```

## 命令说明

| 命令 | 功能 | 说明 |
|------|------|------|
| `list` | 自动刷新 + 智能扫描 | 每3秒刷新，10秒后自动HTTP扫描 |
| `scan` | 手动 HTTP 扫描 | 立即扫描整个子网（高级） |
| `info` | 本机信息 | 显示 IP、指纹、端口等 |
| `quit` | 退出 | 停止服务并退出 |

## 技术细节

### LocalSend v2 协议

- **多播地址**: `224.0.0.167`
- **端口**: `53317` (TCP/UDP)
- **API**:
  - `GET /api/localsend/v2/info` - 获取设备信息
  - `POST /api/localsend/v2/register` - 设备注册

### 关键特性

- **智能网络优先级**: 自动识别 WiFi > 以太网 > 虚拟网卡，优先扫描真实网络
- **自动过滤**: 排除虚拟网卡（WSL, Hyper-V, Docker）、VPN（Tailscale）、APIPA（169.254.x.x）
- **防自响应**: fingerprint 过滤
- **设备超时**: 10秒未响应自动移除
- **端口冲突**: 自动递增 (53318, 53319...)
- **并发扫描**: 50 个并发请求
- **快速超时**: HTTP 请求 1-2 秒超时

**网络接口优先级示例**:
```
有 7 个网络接口时:
✓ WLAN (192.168.11.196)          - Priority: 100  [扫描]
✓ 本地连接 (192.168.137.1)       - Priority: 1    [扫描]
✗ Tailscale (100.100.10.54)      - Priority: -5   [过滤]
✗ 以太网 7 (172.31.0.1)          - Priority: -5   [过滤]
✗ vEthernet (172.28.176.1)       - Priority: -10  [过滤]
✗ APIPA (169.254.183.189)        - Priority: -20  [过滤]

结果: 只扫描 WiFi 和真实网络，避免浪费时间在虚拟网卡上
```

## 故障排查

### 无法发现设备

1. **检查防火墙**: 允许 UDP/TCP 53317
2. **等待或手动扫描**:
   - 正常网络: 等待 2 秒
   - AP 隔离: 等待 10 秒自动扫描，或手动 `scan`
3. **检查网络**: 确保同一局域网

### 端口被占用

程序会自动使用下一个端口，启动时会显示实际端口号。

### AP 隔离网络

输入 `list` 后等待 10 秒，程序会自动触发 HTTP 扫描。

## 构建可执行文件

```bash
# Windows
build.bat

# Linux/Mac
./build.sh

# 生成位置
dist/lan-discovery.exe     # Windows
dist/lan-discovery-linux   # Linux
dist/lan-discovery-macos   # macOS
```

## 参考文档

- [LocalSend 官方](https://github.com/localsend/localsend)
- [协议规范](https://github.com/localsend/protocol)
- 详细技术文档见 `doc/` 目录

## License

MIT
